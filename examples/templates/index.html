<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>gitbench Repository Analysis</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding-top: 20px;
            padding-bottom: 20px;
        }
        .progress {
            height: 25px;
            margin-bottom: 10px;
        }
        .card {
            margin-bottom: 20px;
        }
        .status-badge {
            font-size: 1rem;
        }
        #cloneStatus, #analysisResults {
            display: none;
        }
        .chart-container {
            height: 300px;
            margin-bottom: 20px;
        }
        .status-queued {
            background-color: #ffc107;
        }
        .status-cloning {
            background-color: #0d6efd;
        }
        .status-completed {
            background-color: #198754;
        }
        .status-failed, .status-error {
            background-color: #dc3545;
        }
        pre {
            background-color: #f8f9fa;
            border-radius: 5px;
            padding: 10px;
            max-height: 400px;
            overflow-y: auto;
        }
        table {
            width: 100%;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="row mb-4">
            <div class="col">
                <h1 class="display-4">gitbench Repository Analysis</h1>
                <p class="lead">Web-based repository analysis tool powered by gitbench and Flask</p>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <!-- Repository Form -->
                <div class="card" id="repoForm">
                    <div class="card-header">
                        <h5 class="card-title">Repository Information</h5>
                    </div>
                    <div class="card-body">
                        <form id="repositoryForm">
                            <div class="mb-3">
                                <label for="repositoryUrl" class="form-label">Repository URL</label>
                                <input type="text" class="form-control" id="repositoryUrl" required
                                    placeholder="https://github.com/username/repository.git">
                            </div>
                            <div class="mb-3">
                                <label for="githubUsername" class="form-label">GitHub Username (optional)</label>
                                <input type="text" class="form-control" id="githubUsername" 
                                    placeholder="Your GitHub username">
                            </div>
                            <div class="mb-3">
                                <label for="githubToken" class="form-label">GitHub Token (optional)</label>
                                <input type="password" class="form-control" id="githubToken" 
                                    placeholder="Your GitHub personal access token">
                            </div>
                            <button type="submit" class="btn btn-primary">Clone Repository</button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <!-- Clone Status -->
                <div class="card" id="cloneStatus">
                    <div class="card-header">
                        <h5 class="card-title">Clone Status</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <strong>Repository:</strong> <span id="statusRepoUrl"></span>
                        </div>
                        <div class="mb-3">
                            <strong>Status:</strong> 
                            <span class="badge status-badge" id="statusBadge">Initializing</span>
                        </div>
                        <div class="mb-3">
                            <strong>Elapsed Time:</strong> <span id="statusElapsedTime">0s</span>
                        </div>
                        <div class="progress-container" id="progressContainer">
                            <label>Progress:</label>
                            <div class="progress">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                    id="cloneProgressBar" role="progressbar" 
                                    aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" 
                                    style="width: 0%">0%</div>
                            </div>
                        </div>
                        <div class="mb-3 mt-3" id="repoDirectoryContainer" style="display: none;">
                            <strong>Repository Directory:</strong> <span id="repoDirectory"></span>
                        </div>
                        <div class="mt-3" id="analysisButtons" style="display: none;">
                            <button class="btn btn-success" id="extractCommitsBtn">Extract Commits</button>
                            <div class="mt-3" id="blameOptions">
                                <h6>Select Directories for Blame Analysis:</h6>
                                <div class="mb-2" id="directoryOptions">
                                    <div class="spinner-border spinner-border-sm" role="status">
                                        <span class="visually-hidden">Loading directories...</span>
                                    </div>
                                    <small>Loading directories...</small>
                                </div>
                                <button class="btn btn-info" id="runBlameBtn" disabled>Run Blame Analysis</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Analysis Results -->
        <div class="row mt-4" id="analysisResults">
            <div class="col-12">
                <ul class="nav nav-tabs" id="analysisTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="commits-tab" data-bs-toggle="tab" 
                            data-bs-target="#commits" type="button" role="tab" 
                            aria-controls="commits" aria-selected="true">Commit History</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="blame-tab" data-bs-toggle="tab" 
                            data-bs-target="#blame" type="button" role="tab" 
                            aria-controls="blame" aria-selected="false">Blame Analysis</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="performance-tab" data-bs-toggle="tab" 
                            data-bs-target="#performance" type="button" role="tab" 
                            aria-controls="performance" aria-selected="false">Performance</button>
                    </li>
                </ul>
                <div class="tab-content p-3 border border-top-0 rounded-bottom" id="analysisTabContent">
                    <!-- Commits Tab -->
                    <div class="tab-pane fade show active" id="commits" role="tabpanel" aria-labelledby="commits-tab">
                        <div id="commitsLoading">
                            <div class="d-flex justify-content-center">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                            <p class="text-center">Extracting commit history...</p>
                        </div>
                        <div id="commitsContent" style="display: none;">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5 class="card-title">Commit Summary</h5>
                                        </div>
                                        <div class="card-body">
                                            <p><strong>Total Commits:</strong> <span id="totalCommits">0</span></p>
                                            <p><strong>Date Range:</strong> <span id="commitDateRange">N/A</span></p>
                                            <p><strong>Lines Added:</strong> <span id="linesAdded">0</span></p>
                                            <p><strong>Lines Deleted:</strong> <span id="linesDeleted">0</span></p>
                                            <p><strong>Net Change:</strong> <span id="netChange">0</span></p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5 class="card-title">Top Contributors</h5>
                                        </div>
                                        <div class="card-body">
                                            <table class="table table-sm">
                                                <thead>
                                                    <tr>
                                                        <th>Author</th>
                                                        <th>Commits</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="topContributorsTable">
                                                    <!-- Will be filled by JavaScript -->
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5 class="card-title">Commits by Month</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="chart-container">
                                                <canvas id="commitsByMonthChart"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="commitsError" style="display: none;">
                            <div class="alert alert-danger" role="alert">
                                <h4 class="alert-heading">Error Extracting Commits</h4>
                                <p id="commitsErrorMessage">An error occurred while extracting commit history.</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Blame Tab -->
                    <div class="tab-pane fade" id="blame" role="tabpanel" aria-labelledby="blame-tab">
                        <div id="blameLoading">
                            <div class="d-flex justify-content-center">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                            <p class="text-center">Running blame analysis...</p>
                        </div>
                        <div id="blameContent" style="display: none;">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5 class="card-title">Authors by Line Count</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="chart-container">
                                                <canvas id="authorLinesChart"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5 class="card-title">Files by Line Count</h5>
                                        </div>
                                        <div class="card-body">
                                            <table class="table table-sm">
                                                <thead>
                                                    <tr>
                                                        <th>File</th>
                                                        <th>Lines</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="topFilesTable">
                                                    <!-- Will be filled by JavaScript -->
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5 class="card-title">Author Distribution for Top Files</h5>
                                        </div>
                                        <div class="card-body" id="fileAuthorDistribution">
                                            <!-- Will be filled by JavaScript -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="blameError" style="display: none;">
                            <div class="alert alert-danger" role="alert">
                                <h4 class="alert-heading">Error Running Blame Analysis</h4>
                                <p id="blameErrorMessage">An error occurred while running blame analysis.</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Performance Tab -->
                    <div class="tab-pane fade" id="performance" role="tabpanel" aria-labelledby="performance-tab">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="card-title">Clone Performance</h5>
                                    </div>
                                    <div class="card-body">
                                        <p><strong>Clone Duration:</strong> <span id="cloneDuration">N/A</span></p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="card-title">Commit Extraction Performance</h5>
                                    </div>
                                    <div class="card-body" id="commitPerformance">
                                        <p><strong>Duration:</strong> <span id="commitDuration">N/A</span></p>
                                        <p><strong>Commits Processed:</strong> <span id="commitsProcessed">0</span></p>
                                        <p><strong>Commits/Second:</strong> <span id="commitsPerSecond">0</span></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="card-title">Blame Analysis Performance</h5>
                                    </div>
                                    <div class="card-body" id="blamePerformance">
                                        <p><strong>Total Duration:</strong> <span id="blameTotalDuration">N/A</span></p>
                                        <p><strong>Core Blame Duration:</strong> <span id="blameCoreDuration">N/A</span></p>
                                        <p><strong>Files Processed:</strong> <span id="filesProcessed">0</span></p>
                                        <p><strong>Lines Analyzed:</strong> <span id="linesAnalyzed">0</span></p>
                                        <p><strong>Files/Second:</strong> <span id="filesPerSecond">0</span></p>
                                        <p><strong>Lines/Second:</strong> <span id="linesPerSecond">0</span></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Global variables
        let sessionId = null;
        let statusInterval = null;
        let currentStatus = null;

        // DOM Elements
        const repositoryForm = document.getElementById('repositoryForm');
        const cloneStatusDiv = document.getElementById('cloneStatus');
        const analysisResultsDiv = document.getElementById('analysisResults');
        const analysisButtonsDiv = document.getElementById('analysisButtons');
        const extractCommitsBtn = document.getElementById('extractCommitsBtn');
        const runBlameBtn = document.getElementById('runBlameBtn');

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Handle form submission
            repositoryForm.addEventListener('submit', function(e) {
                e.preventDefault();
                startClone();
            });

            // Handle analysis buttons
            extractCommitsBtn.addEventListener('click', function() {
                startCommitExtraction();
            });

            runBlameBtn.addEventListener('click', function() {
                startBlameAnalysis();
            });
        });

        // Start clone operation
        function startClone() {
            const repoUrl = document.getElementById('repositoryUrl').value;
            const githubUsername = document.getElementById('githubUsername').value;
            const githubToken = document.getElementById('githubToken').value;

            // Show clone status div
            cloneStatusDiv.style.display = 'block';
            document.getElementById('statusRepoUrl').textContent = repoUrl;
            document.getElementById('statusBadge').textContent = 'Initializing';
            document.getElementById('statusBadge').className = 'badge status-badge';

            // Reset progress
            document.getElementById('cloneProgressBar').style.width = '0%';
            document.getElementById('cloneProgressBar').textContent = '0%';
            document.getElementById('repoDirectoryContainer').style.display = 'none';
            analysisButtonsDiv.style.display = 'none';
            analysisResultsDiv.style.display = 'none';

            // Send request to start clone
            fetch('/api/start_clone', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    repo_url: repoUrl,
                    github_username: githubUsername,
                    github_token: githubToken
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                    return;
                }

                // Store session ID and start monitoring
                sessionId = data.session_id;
                startStatusMonitoring();
            })
            .catch(error => {
                console.error('Error starting clone:', error);
                alert('Failed to start cloning. See console for details.');
            });
        }

        // Start status monitoring
        function startStatusMonitoring() {
            if (statusInterval) {
                clearInterval(statusInterval);
            }

            // Check status every second
            statusInterval = setInterval(function() {
                if (!sessionId) return;

                fetch(`/api/status/${sessionId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            console.error(data.error);
                            clearInterval(statusInterval);
                            return;
                        }

                        updateCloneStatus(data);
                    })
                    .catch(error => {
                        console.error('Error fetching status:', error);
                    });
            }, 1000);
        }

        // Fetch available directories for blame analysis
        function fetchDirectories() {
            if (!sessionId) return;
            
            const directoryOptions = document.getElementById('directoryOptions');
            
            fetch(`/api/list_directories/${sessionId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        directoryOptions.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                        return;
                    }
                    
                    // Create checkboxes for directory selection
                    directoryOptions.innerHTML = '';
                    if (data.directories && data.directories.length > 0) {
                        const dirList = document.createElement('div');
                        dirList.className = 'directory-list';
                        
                        data.directories.forEach(dir => {
                            const dirItem = document.createElement('div');
                            dirItem.className = 'form-check';
                            
                            const checkbox = document.createElement('input');
                            checkbox.type = 'checkbox';
                            checkbox.className = 'form-check-input directory-checkbox';
                            checkbox.id = `dir_${dir.replace(/[^a-zA-Z0-9]/g, '_')}`;
                            checkbox.value = dir;
                            
                            const label = document.createElement('label');
                            label.className = 'form-check-label';
                            label.htmlFor = checkbox.id;
                            label.textContent = dir;
                            
                            dirItem.appendChild(checkbox);
                            dirItem.appendChild(label);
                            dirList.appendChild(dirItem);
                        });
                        
                        directoryOptions.appendChild(dirList);
                        
                        // Enable/disable blame button based on selection
                        const checkboxes = document.querySelectorAll('.directory-checkbox');
                        checkboxes.forEach(checkbox => {
                            checkbox.addEventListener('change', function() {
                                const checkedDirs = document.querySelectorAll('.directory-checkbox:checked');
                                document.getElementById('runBlameBtn').disabled = checkedDirs.length === 0;
                            });
                        });
                        
                        // Enable run blame button now that directories are loaded
                        document.getElementById('runBlameBtn').disabled = true;
                    } else {
                        directoryOptions.innerHTML = '<div class="alert alert-warning">No directories found in repository</div>';
                        document.getElementById('runBlameBtn').disabled = true;
                    }
                })
                .catch(error => {
                    console.error('Error fetching directories:', error);
                    directoryOptions.innerHTML = '<div class="alert alert-danger">Failed to load directories</div>';
                });
        }

        // Update clone status display
        function updateCloneStatus(data) {
            currentStatus = data;
            const statusBadge = document.getElementById('statusBadge');
            const statusClass = `badge status-badge status-${data.status}`;

            // Update badge
            statusBadge.textContent = data.status.toUpperCase();
            statusBadge.className = statusClass;

            // Update elapsed time
            document.getElementById('statusElapsedTime').textContent = data.elapsed_time;

            // Get latest status update
            if (data.history && data.history.length > 0) {
                const latest = data.history[data.history.length - 1];

                // Update progress bar if cloning
                if (latest.status === 'cloning' && latest.progress !== null) {
                    const progressBar = document.getElementById('cloneProgressBar');
                    progressBar.style.width = `${latest.progress}%`;
                    progressBar.textContent = `${latest.progress}%`;
                    document.getElementById('progressContainer').style.display = 'block';
                }
            }

            // If directory is available, show it
            if (data.temp_dir) {
                document.getElementById('repoDirectoryContainer').style.display = 'block';
                document.getElementById('repoDirectory').textContent = data.temp_dir;
            }

            // If completed, show analysis buttons
            if (data.status === 'completed') {
                analysisButtonsDiv.style.display = 'block';
                clearInterval(statusInterval); // Stop polling
                
                // Update performance tab with clone duration
                document.getElementById('cloneDuration').textContent = data.elapsed_time;
                
                // Fetch available directories
                fetchDirectories();
            }
        }

        // Start commit extraction
        function startCommitExtraction() {
            if (!sessionId) return;

            // Show loading state
            document.getElementById('commitsLoading').style.display = 'block';
            document.getElementById('commitsContent').style.display = 'none';
            document.getElementById('commitsError').style.display = 'none';
            
            // Show analysis results div and select commits tab
            analysisResultsDiv.style.display = 'block';
            const commitsTab = new bootstrap.Tab(document.getElementById('commits-tab'));
            commitsTab.show();

            // Send request to extract commits
            fetch(`/api/extract_commits/${sessionId}`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showCommitError(data.error);
                    return;
                }

                // Start polling for results
                pollCommitResults();
            })
            .catch(error => {
                console.error('Error starting commit extraction:', error);
                showCommitError('Failed to start commit extraction');
            });
        }

        // Poll for commit results
        function pollCommitResults() {
            const interval = setInterval(function() {
                if (!sessionId) {
                    clearInterval(interval);
                    return;
                }

                fetch(`/api/results/${sessionId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            clearInterval(interval);
                            return;
                        }

                        if (data.commits) {
                            clearInterval(interval);
                            displayCommitResults(data.commits);
                        }
                    })
                    .catch(error => {
                        console.error('Error polling commit results:', error);
                        clearInterval(interval);
                        showCommitError('Failed to fetch commit results');
                    });
            }, 1000);
        }

        // Display commit results
        function displayCommitResults(commits) {
            if (commits.error || commits.status === 'error' || commits.status === 'failed') {
                showCommitError(commits.error || 'Failed to extract commits');
                return;
            }

            // Update performance tab
            document.getElementById('commitDuration').textContent = commits.performance?.duration_formatted || 'N/A';
            document.getElementById('commitsProcessed').textContent = commits.count || 0;
            document.getElementById('commitsPerSecond').textContent = 
                commits.performance?.commits_per_second?.toFixed(2) || 0;

            // Update commit summary
            document.getElementById('totalCommits').textContent = commits.count || 0;
            document.getElementById('linesAdded').textContent = commits.total_additions || 0;
            document.getElementById('linesDeleted').textContent = commits.total_deletions || 0;
            document.getElementById('netChange').textContent = commits.net_change || 0;
            
            // Update date range with proper handling for missing values
            if (commits.date_range) {
                const minDate = commits.date_range.min || 'N/A';
                const maxDate = commits.date_range.max || 'N/A';
                const dateRangeText = (minDate === 'N/A' || maxDate === 'N/A') ? 
                    'N/A' : `${minDate} to ${maxDate}`;
                document.getElementById('commitDateRange').textContent = dateRangeText;
            } else {
                document.getElementById('commitDateRange').textContent = 'N/A';
            }
            
            // Populate top contributors table
            const contributorsTable = document.getElementById('topContributorsTable');
            contributorsTable.innerHTML = '';
            
            if (commits.authors) {
                for (const [author, count] of Object.entries(commits.authors)) {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${author}</td>
                        <td>${count}</td>
                    `;
                    contributorsTable.appendChild(row);
                }
            }
            
            // Create commits by month chart
            if (commits.commits_by_month) {
                const labels = Object.keys(commits.commits_by_month);
                const data = Object.values(commits.commits_by_month);
                
                const ctx = document.getElementById('commitsByMonthChart').getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Commits',
                            data: data,
                            backgroundColor: 'rgba(54, 162, 235, 0.6)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Number of Commits'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Month'
                                }
                            }
                        }
                    }
                });
            }
            
            // Show content
            document.getElementById('commitsLoading').style.display = 'none';
            document.getElementById('commitsContent').style.display = 'block';
        }

        // Show commit error
        function showCommitError(message) {
            document.getElementById('commitsLoading').style.display = 'none';
            document.getElementById('commitsContent').style.display = 'none';
            document.getElementById('commitsError').style.display = 'block';
            document.getElementById('commitsErrorMessage').textContent = message;
        }

        // Start blame analysis
        function startBlameAnalysis() {
            if (!sessionId) return;
            
            // Get selected directories
            const selectedDirs = [];
            document.querySelectorAll('.directory-checkbox:checked').forEach(checkbox => {
                selectedDirs.push(checkbox.value);
            });
            
            // Validate selected directories
            if (selectedDirs.length === 0) {
                alert('Please select at least one directory to analyze');
                return;
            }

            // Show loading state
            document.getElementById('blameLoading').style.display = 'block';
            document.getElementById('blameContent').style.display = 'none';
            document.getElementById('blameError').style.display = 'none';
            
            // Show analysis results div and select blame tab
            analysisResultsDiv.style.display = 'block';
            const blameTab = new bootstrap.Tab(document.getElementById('blame-tab'));
            blameTab.show();

            // Send request to run blame analysis
            fetch(`/api/run_blame/${sessionId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    directories: selectedDirs
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showBlameError(data.error);
                    return;
                }

                // Start polling for results
                pollBlameResults();
            })
            .catch(error => {
                console.error('Error starting blame analysis:', error);
                showBlameError('Failed to start blame analysis');
            });
        }

        // Poll for blame results
        function pollBlameResults() {
            const interval = setInterval(function() {
                if (!sessionId) {
                    clearInterval(interval);
                    return;
                }

                fetch(`/api/results/${sessionId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            clearInterval(interval);
                            return;
                        }

                        if (data.blame) {
                            clearInterval(interval);
                            displayBlameResults(data.blame);
                        }
                    })
                    .catch(error => {
                        console.error('Error polling blame results:', error);
                        clearInterval(interval);
                        showBlameError('Failed to fetch blame results');
                    });
            }, 1000);
        }

        // Display blame results
        function displayBlameResults(blame) {
            if (blame.error || blame.status === 'error' || blame.status === 'failed') {
                showBlameError(blame.error || 'Failed to run blame analysis');
                return;
            }

            // Update performance tab
            document.getElementById('blameTotalDuration').textContent = 
                blame.performance?.total_duration_formatted || 'N/A';
            document.getElementById('blameCoreDuration').textContent = 
                blame.performance?.blame_duration_formatted || 'N/A';
            document.getElementById('filesProcessed').textContent = 
                blame.performance?.files_processed || 0;
            document.getElementById('linesAnalyzed').textContent = 
                blame.performance?.total_lines || 0;
            document.getElementById('filesPerSecond').textContent = 
                blame.performance?.files_per_second?.toFixed(2) || 0;
            document.getElementById('linesPerSecond').textContent = 
                blame.performance?.lines_per_second?.toFixed(2) || 0;

            // Populate top files table
            const filesTable = document.getElementById('topFilesTable');
            filesTable.innerHTML = '';
            
            if (blame.statistics?.by_file) {
                for (const [file, count] of Object.entries(blame.statistics.by_file)) {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${file}</td>
                        <td>${count}</td>
                    `;
                    filesTable.appendChild(row);
                }
            }
            
            // Create author lines chart
            if (blame.statistics?.by_author) {
                const labels = Object.keys(blame.statistics.by_author);
                const data = Object.values(blame.statistics.by_author);
                
                const ctx = document.getElementById('authorLinesChart').getContext('2d');
                new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: [
                                'rgba(255, 99, 132, 0.6)',
                                'rgba(54, 162, 235, 0.6)',
                                'rgba(255, 206, 86, 0.6)',
                                'rgba(75, 192, 192, 0.6)',
                                'rgba(153, 102, 255, 0.6)',
                                'rgba(255, 159, 64, 0.6)',
                                'rgba(199, 199, 199, 0.6)',
                                'rgba(83, 102, 255, 0.6)',
                                'rgba(40, 159, 64, 0.6)',
                                'rgba(210, 199, 199, 0.6)'
                            ],
                            borderColor: [
                                'rgba(255, 99, 132, 1)',
                                'rgba(54, 162, 235, 1)',
                                'rgba(255, 206, 86, 1)',
                                'rgba(75, 192, 192, 1)',
                                'rgba(153, 102, 255, 1)',
                                'rgba(255, 159, 64, 1)',
                                'rgba(199, 199, 199, 1)',
                                'rgba(83, 102, 255, 1)',
                                'rgba(40, 159, 64, 1)',
                                'rgba(210, 199, 199, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                            },
                            title: {
                                display: true,
                                text: 'Lines of Code by Author'
                            }
                        }
                    }
                });
            }
            
            // Display author distribution for top files
            const fileAuthorDistribution = document.getElementById('fileAuthorDistribution');
            fileAuthorDistribution.innerHTML = '';
            
            if (blame.statistics?.top_file_authors) {
                for (const [file, fileData] of Object.entries(blame.statistics.top_file_authors)) {
                    const fileDiv = document.createElement('div');
                    fileDiv.className = 'mb-4';
                    
                    // File header
                    const fileHeader = document.createElement('h5');
                    fileHeader.textContent = file;
                    fileDiv.appendChild(fileHeader);
                    
                    // File total lines
                    const totalLines = document.createElement('p');
                    totalLines.className = 'small text-muted';
                    totalLines.textContent = `Total lines: ${fileData.total_lines}`;
                    fileDiv.appendChild(totalLines);
                    
                    // Author table
                    const authorTable = document.createElement('table');
                    authorTable.className = 'table table-sm';
                    authorTable.innerHTML = `
                        <thead>
                            <tr>
                                <th>Author</th>
                                <th>Lines</th>
                                <th>Percentage</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    `;
                    
                    const tbody = authorTable.querySelector('tbody');
                    for (const [author, lines] of Object.entries(fileData.authors)) {
                        const percentage = ((lines / fileData.total_lines) * 100).toFixed(1);
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${author}</td>
                            <td>${lines}</td>
                            <td>${percentage}%</td>
                        `;
                        tbody.appendChild(row);
                    }
                    
                    fileDiv.appendChild(authorTable);
                    fileAuthorDistribution.appendChild(fileDiv);
                }
            }
            
            // Show content
            document.getElementById('blameLoading').style.display = 'none';
            document.getElementById('blameContent').style.display = 'block';
        }

        // Show blame error
        function showBlameError(message) {
            document.getElementById('blameLoading').style.display = 'none';
            document.getElementById('blameContent').style.display = 'none';
            document.getElementById('blameError').style.display = 'block';
            document.getElementById('blameErrorMessage').textContent = message;
        }
    </script>
</body>
</html>
